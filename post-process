#!/usr/bin/perl

# post-process FILE
#   "Clever" post-processing of HTML generated by Markdown.pl.

# +-----------+------------------------------------------------------
# | Libraries |
# +-----------+

use Path::Tiny;

# +------+-----------------------------------------------------------
# | Main |
# +------+

my $file = $ARGV[0];
my $data = path($file)->slurp;
# $data =~ s/h([1-5])>/newHead($1)/ge;
$data =~ s/<h1>.*<\/h1>//g;
$data =~ s/<p>\^(.*)\^<\/p>/includeFile($1)/ge;
print $data;

# +-------------+----------------------------------------------------
# | Subroutines |
# +-------------+

sub newHead($) {
  my ($level) = @_;
  ++$level;
  return "h$level>";
} # newHead

sub includeFile($) {
  my ($fname) = @_;

  # By default, we enclose all included files in pre tags
  my $prefix = "<pre>";
  my $suffix = "</pre>";

  # Except for .html files
  if ($fname =~ m/\.html$/) {
    $prefix = "";
    $suffix = "";
  }

  # Try a file in the same directory.
  my $try1 = path($file)->parent . "/$fname";
  if (-f $try1) {
    return $prefix . path($try1)->slurp . $suffix;
  }

  # Try a file in the current directory
  elsif (-f $fname) {
    return $prefix . path($fname)->slurp . $suffix;
  }

  # That'sit
  else {
    die "Could not find included file '$fname'";
  }
} # includeFile
